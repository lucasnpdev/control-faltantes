<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Picker Jumbo V3</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bg: #121212; 
            --card: #1e1e1e; 
            --text: #e0e0e0; 
            --primary: #00C853; 
            --busy: #D32F2F; 
            --accent: #2962FF; 
            --warning: #FF9800;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; }
        
        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .user-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 90%; max-width: 400px; }
        .user-btn { background: var(--card); color: white; border: 1px solid #333; padding: 20px; font-size: 1.1rem; border-radius: 10px; cursor: pointer; text-align: center; }

        /* HEADER */
        header { position: sticky; top: 0; z-index: 100; background: #000; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .user-badge { font-weight: bold; color: var(--primary); }
        .btn-reset { background: var(--warning); color: #000; border: none; padding: 8px 12px; font-weight: bold; border-radius: 5px; font-size: 0.8rem; }

        /* CONTENEDORES */
        .container { padding: 10px; max-width: 800px; margin: 0 auto; }
        .section-title { color: var(--busy); border-bottom: 1px solid var(--busy); margin: 20px 0 10px 0; padding-bottom: 5px; font-weight: bold; font-size: 1.1rem; }

        /* CATEGORIAS */
        .cat-card { background: var(--card); padding: 20px; margin-bottom: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid transparent; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .cat-card.busy { background: #2c1515; border-color: var(--busy); opacity: 0.6; pointer-events: none; }
        .cat-card.active-user { background: #1a3320; border-color: var(--primary); opacity: 1; pointer-events: auto; }

        /* PRODUCTOS */
        .prod-card { background: var(--card); padding: 10px; margin-bottom: 8px; border-radius: 6px; display: grid; grid-template-columns: 40px 1fr 110px; gap: 10px; align-items: center; border: 1px solid #333; }
        .prod-card.checked { background: #1b5e20; border-color: var(--primary); } /* Verde Controlado */
        
        /* COLUMNA 1: REORDENAR */
        .order-col { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .btn-arrow { background: #333; color: white; border: none; width: 30px; height: 30px; border-radius: 4px; font-size: 1rem; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        
        /* COLUMNA 2: INFO */
        .prod-info { overflow: hidden; }
        .prod-name { font-size: 1rem; font-weight: 500; display: block; margin-bottom: 4px; color: #fff; line-height: 1.3; }
        .prod-meta { font-size: 0.75rem; color: #aaa; }

        /* COLUMNA 3: ACCIONES */
        .actions-col { display: flex; flex-direction: column; gap: 8px; align-items: flex-end; }
        
        .btn-copy { background: var(--accent); color: white; border: none; padding: 8px; border-radius: 4px; font-size: 0.85rem; font-weight: bold; cursor: pointer; width: 100%; text-align: center; }
        
        .btn-stock { background: var(--busy); color: white; border: none; padding: 6px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; width: 100%; text-align: center; font-weight: bold; text-transform: uppercase; }
        .btn-stock.restore { background: #444; color: #ccc; } /* Bot√≥n gris para "Devolver a stock" */

        .btn-edit { background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 0; margin-left: 5px; }

        /* NAVEGACION */
        #view-products { display: none; }
        .back-bar { background: #222; padding: 10px; display: flex; align-items: center; gap: 15px; position: sticky; top: 60px; z-index: 99; border-bottom: 1px solid #333; }
        .back-btn { background: #444; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; }
        
        /* AGREGAR PRODUCTO */
        .add-area { margin-top: 30px; padding: 15px; background: #151515; border-radius: 8px; display: flex; gap: 10px; }
        .input-dark { flex-grow: 1; padding: 12px; background: #000; border: 1px solid #444; color: white; border-radius: 5px; font-size: 1rem; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2 style="color: var(--primary);">Identif√≠cate</h2>
        <div class="user-grid">
            <div class="user-btn" onclick="login('Valen')">Valen</div>
            <div class="user-btn" onclick="login('Eros')">Eros</div>
            <div class="user-btn" onclick="login('Fabri')">Fabri</div>
            <div class="user-btn" onclick="login('Lucas')">Lucas</div>
            <div class="user-btn" onclick="login('Gabriel')">Gabriel</div>
        </div>
    </div>

    <div id="app-content" style="display:none;">
        <header>
            <div class="user-badge" id="user-display">Usuario</div>
            <button class="btn-reset" onclick="reiniciarDia()">üîÑ Nuevo D√≠a</button>
        </header>

        <div class="container" id="view-categories">
            
            <div id="sin-stock-container" style="display:none;">
                <h3 class="section-title" id="sin-stock-title">SIN STOCK [FECHA]</h3>
                <div id="sin-stock-list"></div>
            </div>

            <h3 class="section-title" style="color: #666; border-color: #444; margin-top:30px;">SECTORES</h3>
            <div id="categories-list"></div>
        </div>

        <div id="view-products">
            <div class="back-bar">
                <button class="back-btn" onclick="salirCategoria()">‚¨Ö Volver</button>
                <span id="cat-title" style="font-weight:bold; font-size:1.1rem; color:white;">Categoria</span>
            </div>
            
            <div class="container">
                <div id="products-list"></div>

                <div class="add-area">
                    <input type="text" id="new-prod-name" class="input-dark" placeholder="Agregar producto nuevo...">
                    <button onclick="agregarProducto()" style="background:var(--primary); border:none; width:50px; font-size:1.5rem; border-radius:5px;">+</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN FIREBASE (REEMPLAZA CON LA TUYA) ---
        const firebaseConfig = {
          apiKey: "AIzaSyCfj4L-O-80sVzA7pzqGpZ4bl0iaVEeeeU",
          authDomain: "control-faltantes.firebaseapp.com",
          databaseURL: "https://control-faltantes-default-rtdb.firebaseio.com",
          projectId: "control-faltantes",
          storageBucket: "control-faltantes.firebasestorage.app",
          messagingSenderId: "599058830915",
          appId: "1:599058830915:web:4d48395640d7981c1626f6"
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ESTADO
        let currentUser = null;
        let currentCatID = null;
        let productsCache = []; // Para facilitar el reordenamiento

        // --- FUNCIONES ---

        function login(user) {
            currentUser = user;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            document.getElementById('user-display').innerText = user;
            
            // Iniciar Escucha
            db.ref('categorias').orderByChild('nombre').on('value', snap => renderCategorias(snap.val() || {}));
            db.ref('productos').on('value', snap => {
                const data = snap.val() || {};
                renderSinStock(data);
                if(currentCatID) renderProductos(data);
            });
        }

        // 1. RENDERIZADO DE CATEGORIAS
        function renderCategorias(catsObj) {
            const list = document.getElementById('categories-list');
            list.innerHTML = '';
            
            const sortedCats = Object.keys(catsObj).map(key => ({id: key, ...catsObj[key]}));
            sortedCats.sort((a,b) => a.nombre.localeCompare(b.nombre));

            sortedCats.forEach(cat => {
                const el = document.createElement('div');
                const busy = cat.usuario_activo && cat.usuario_activo !== currentUser;
                const mine = cat.usuario_activo === currentUser;

                el.className = `cat-card ${busy ? 'busy' : ''} ${mine ? 'active-user' : ''}`;
                
                let status = "";
                if(busy) status = `<span style="color:var(--busy); font-size:0.8rem">‚ö†Ô∏è ${cat.usuario_activo}</span>`;
                if(mine) status = `<span style="color:var(--primary); font-size:0.8rem">üü¢ TUYO</span>`;

                el.innerHTML = `<strong>${cat.nombre}</strong> ${status}`;
                el.onclick = () => { if(!busy) entrarCategoria(cat.id, cat.nombre); };
                list.appendChild(el);
            });
        }

        // 2. RENDERIZADO LISTA "SIN STOCK" (GLOBAL)
        function renderSinStock(prodsObj) {
            const container = document.getElementById('sin-stock-list');
            const wrapper = document.getElementById('sin-stock-container');
            const title = document.getElementById('sin-stock-title');
            
            container.innerHTML = '';
            
            // Obtener fecha de hoy para el t√≠tulo
            const hoy = new Date().toLocaleDateString('es-AR');
            title.innerText = `SIN STOCK [${hoy}]`;

            let count = 0;
            Object.keys(prodsObj).forEach(key => {
                const p = prodsObj[key];
                // Si tiene fecha de sin stock, lo mostramos aqu√≠
                if(p.fecha_sin_stock) {
                    count++;
                    const div = document.createElement('div');
                    div.className = "prod-card";
                    div.style.borderColor = "var(--busy)";
                    div.innerHTML = `
                        <div></div>
                        <div class="prod-info">
                            <span class="prod-name">${p.nombre}</span>
                            <small style="color:#777">Origen: ${p.cat_nombre || 'N/A'}</small>
                        </div>
                        <div class="actions-col">
                            <button class="btn-stock restore" onclick="restaurarStock('${key}')">Devolver a Stock</button>
                        </div>
                    `;
                    container.appendChild(div);
                }
            });
            wrapper.style.display = count > 0 ? 'block' : 'none';
        }

        // 3. RENDERIZADO PRODUCTOS (DENTRO DE CATEGORIA)
        function renderProductos(prodsObj) {
            const container = document.getElementById('products-list');
            const catName = document.getElementById('cat-title').innerText;
            const esDesactivarSiempre = catName.includes("Desactivar siempre"); // Verificamos la categoria especial
            
            container.innerHTML = '';
            productsCache = []; // Limpiamos cache local

            // Filtramos solo los de esta categor√≠a Y que tengan stock (los sin stock se van a la otra lista)
            const list = Object.keys(prodsObj)
                .map(k => ({id: k, ...prodsObj[k]}))
                .filter(p => p.categoria_id === currentCatID && !p.fecha_sin_stock);

            // Ordenar por campo 'orden'
            list.sort((a,b) => (a.orden || 0) - (b.orden || 0));
            productsCache = list; // Guardamos para usar en swap

            list.forEach((p, index) => {
                const el = document.createElement('div');
                el.className = `prod-card ${p.controlado ? 'checked' : ''}`;
                
                // Bot√≥n "MARCAR SIN STOCK" (Solo si NO es la categor√≠a "Desactivar siempre")
                const btnStockHTML = esDesactivarSiempre ? '' : 
                    `<button class="btn-stock" onclick="marcarSinStock('${p.id}')">MARCAR SIN STOCK</button>`;

                el.innerHTML = `
                    <div class="order-col">
                        <button class="btn-arrow" onclick="moverProducto('${p.id}', ${p.orden}, -1, ${index})">‚¨Ü</button>
                        <button class="btn-arrow" onclick="moverProducto('${p.id}', ${p.orden}, 1, ${index})">‚¨á</button>
                    </div>
                    
                    <div class="prod-info">
                        <span class="prod-name">
                            ${p.nombre} 
                            <button class="btn-edit" onclick="editarNombreSeguro('${p.id}', '${p.nombre.replace(/'/g, "\\'")}')">‚úèÔ∏è</button>
                        </span>
                        <div class="prod-meta">
                            ${!esDesactivarSiempre ? `<span style="color:#4CAF50">En Stock</span>` : 'Permanente'}
                            | <span style="color:#d32f2f; cursor:pointer;" onclick="eliminar('${p.id}')">Eliminar</span>
                        </div>
                    </div>

                    <div class="actions-col">
                        <button class="btn-copy" onclick="copiar('${p.id}', '${p.nombre.replace(/'/g, "\\'")}')">COPIAR</button>
                        ${btnStockHTML}
                    </div>
                `;
                container.appendChild(el);
            });
        }

        // --- ACCIONES DE DATOS ---

        function moverProducto(id, ordenActual, direccion, indexArray) {
            // Direcci√≥n: -1 (Subir), 1 (Bajar)
            if (!ordenActual) ordenActual = 0;
            
            const newIndex = indexArray + direccion;
            // Verificar limites
            if (newIndex < 0 || newIndex >= productsCache.length) return;

            const vecino = productsCache[newIndex];
            
            // Intercambiamos valores de orden en Firebase
            const updates = {};
            updates[`productos/${id}/orden`] = vecino.orden || 0;
            updates[`productos/${vecino.id}/orden`] = ordenActual;

            db.ref().update(updates);
        }

        function editarNombreSeguro(id, nombreActual) {
            // Usamos prompt nativo para evitar ediciones accidentales
            const nuevoNombre = prompt("Editar nombre del producto:", nombreActual);
            if (nuevoNombre && nuevoNombre.trim() !== "") {
                db.ref(`productos/${id}`).update({ nombre: nuevoNombre.trim() });
            }
        }

        function marcarSinStock(id) {
            const fechaHoy = new Date().toLocaleDateString('es-AR');
            // Al agregar la fecha, desaparece de la lista normal y aparece en la lista "Sin Stock"
            db.ref(`productos/${id}`).update({ fecha_sin_stock: fechaHoy });
        }

        function restaurarStock(id) {
            // Borrar la fecha hace que vuelva a su categor√≠a original
            db.ref(`productos/${id}`).update({ fecha_sin_stock: null });
        }

        function copiar(id, texto) {
            navigator.clipboard.writeText(texto).then(() => {
                db.ref(`productos/${id}`).update({ controlado: true });
                if(navigator.vibrate) navigator.vibrate(50);
            });
        }

        function agregarProducto() {
            const nombre = document.getElementById('new-prod-name').value.trim();
            if(!nombre) return;
            
            // Ponemos un orden alto para que vaya al final
            const ultimoOrden = productsCache.length > 0 ? (productsCache[productsCache.length-1].orden || 0) + 100 : 1000;

            db.ref('productos').push({
                nombre: nombre,
                categoria_id: currentCatID,
                cat_nombre: document.getElementById('cat-title').innerText,
                controlado: false,
                orden: ultimoOrden
            });
            document.getElementById('new-prod-name').value = '';
        }

        function eliminar(id) {
            if(confirm("¬øEliminar definitivamente?")) {
                db.ref(`productos/${id}`).remove();
            }
        }

        // --- NAVEGACION ---
        function entrarCategoria(id, nombre) {
            currentCatID = id;
            document.getElementById('cat-title').innerText = nombre;
            document.getElementById('view-categories').style.display = 'none';
            document.getElementById('view-products').style.display = 'block';
            window.scrollTo(0,0);
            
            db.ref(`categorias/${id}`).update({ usuario_activo: currentUser });
            db.ref(`categorias/${id}/usuario_activo`).onDisconnect().set("");
            
            db.ref('productos').once('value', s => {
                const data = s.val() || {};
                renderProductos(data);
            });
        }

        function salirCategoria() {
            if(currentCatID) {
                db.ref(`categorias/${currentCatID}`).update({ usuario_activo: "" });
                db.ref(`categorias/${currentCatID}/usuario_activo`).onDisconnect().cancel();
                currentCatID = null;
                document.getElementById('view-products').style.display = 'none';
                document.getElementById('view-categories').style.display = 'block';
            }
        }

        function reiniciarDia() {
            if(confirm("¬øINICIAR NUEVO D√çA?\nSe borrar√°n las marcas verdes. La lista 'Sin Stock' se mantiene.")) {
                db.ref('productos').once('value', snap => {
                    const updates = {};
                    snap.forEach(child => {
                        updates[`productos/${child.key}/controlado`] = false;
                    });
                    db.ref('categorias').once('value', catSnap => {
                        catSnap.forEach(c => {
                            updates[`categorias/${c.key}/usuario_activo`] = "";
                        });
                        db.ref().update(updates);
                    });
                });
            }
        }
    </script>
</body>
</html>
