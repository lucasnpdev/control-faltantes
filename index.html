<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Picker Jumbo Control</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bg: #121212; 
            --card: #1e1e1e; 
            --text: #e0e0e0; 
            --primary: #00C853; 
            --busy: #D32F2F; 
            --accent: #2962FF; 
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 50px; }
        
        /* PANTALLA LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .user-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 90%; max-width: 400px; }
        .user-btn { background: var(--card); color: white; border: 1px solid #333; padding: 20px; font-size: 1.1rem; border-radius: 10px; cursor: pointer; text-align: center; }
        .user-btn:active { background: var(--primary); color: black; }

        /* HEADER */
        header { position: sticky; top: 0; z-index: 10; background: #000; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .user-badge { font-weight: bold; color: var(--primary); font-size: 0.9rem; }
        .btn-reset { background: #FF9800; color: #000; border: none; padding: 8px 12px; font-weight: bold; border-radius: 5px; font-size: 0.8rem; }

        /* CONTENEDORES */
        .container { padding: 10px; max-width: 800px; margin: 0 auto; }
        .section-title { color: #888; border-bottom: 1px solid #333; margin: 20px 0 10px 0; padding-bottom: 5px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }

        /* CATEGORIAS */
        .cat-card { background: var(--card); padding: 18px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-left: 5px solid transparent; }
        .cat-card.busy { background: #2c1515; border-color: var(--busy); opacity: 0.7; pointer-events: none; }
        .cat-card.active-user { background: #1a3320; border-color: var(--primary); opacity: 1; pointer-events: auto; }
        .cat-status { font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }

        /* PRODUCTOS */
        .prod-card { background: var(--card); padding: 12px; margin-bottom: 8px; border-radius: 6px; display: flex; align-items: center; gap: 10px; transition: background 0.2s; }
        .prod-card.checked { background: #1b5e20; } /* Verde Controlado */
        
        .prod-details { flex-grow: 1; overflow: hidden; }
        .prod-name { font-size: 1rem; font-weight: 500; display: block; margin-bottom: 6px; color: #fff; }
        .prod-meta { font-size: 0.75rem; color: #aaa; }

        /* BOTONES PRODUCTO */
        .actions { display: flex; flex-direction: column; gap: 5px; align-items: flex-end; }
        
        .btn-copy { background: var(--accent); color: white; border: none; padding: 8px 15px; border-radius: 5px; font-size: 0.9rem; font-weight: bold; cursor: pointer; width: 100px; }
        .btn-copy:active { transform: scale(0.95); }

        /* SWITCH STOCK */
        .stock-toggle { background: #333; color: #aaa; border: 1px solid #444; padding: 5px 10px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; text-align: center; width: 100px; }
        .stock-toggle.sin-stock { background: var(--busy); color: white; border-color: var(--busy); }

        /* NAVEGACION */
        #view-products { display: none; }
        .back-bar { background: #222; padding: 10px; display: flex; align-items: center; gap: 10px; position: sticky; top: 58px; z-index: 9; border-bottom: 1px solid #333; }
        .btn-back { background: transparent; color: white; border: 1px solid #555; padding: 5px 15px; border-radius: 20px; font-size: 1.2rem; }
        
        /* AGREGAR PRODUCTO */
        .add-area { margin-top: 20px; padding: 15px; background: #151515; border-radius: 8px; }
        .add-row { display: flex; gap: 10px; }
        .input-dark { flex-grow: 1; padding: 10px; background: #000; border: 1px solid #444; color: white; border-radius: 5px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2 style="color: var(--primary);">Selecciona Usuario</h2>
        <div class="user-grid">
            <div class="user-btn" onclick="login('Picker 1')">Picker 1</div>
            <div class="user-btn" onclick="login('Picker 2')">Picker 2</div>
            <div class="user-btn" onclick="login('Picker 3')">Picker 3</div>
            <div class="user-btn" onclick="login('Picker 4')">Picker 4</div>
            <div class="user-btn" onclick="login('Picker 5')">Picker 5</div>
        </div>
    </div>

    <div id="app-content" style="display:none;">
        <header>
            <div class="user-badge" id="user-display">Usuario</div>
            <button class="btn-reset" onclick="reiniciarDia()">üåÖ Nuevo D√≠a</button>
        </header>

        <div class="container" id="view-categories">
            <div id="sin-stock-container" style="display:none;">
                <h3 class="section-title" style="color: var(--busy);">‚ö†Ô∏è SIN STOCK (Reporte Diario)</h3>
                <div id="sin-stock-list"></div>
            </div>

            <h3 class="section-title">Sectores Disponibles</h3>
            <div id="categories-list"></div>
        </div>

        <div id="view-products">
            <div class="back-bar">
                <button class="btn-back" onclick="salirCategoria()">‚¨Ö</button>
                <span id="cat-title" style="font-weight:bold; font-size:1.1rem;">Categoria</span>
            </div>
            
            <div class="container">
                <div id="products-list"></div>

                <div class="add-area">
                    <div class="add-row">
                        <input type="text" id="new-prod-name" class="input-dark" placeholder="Nuevo producto...">
                        <button onclick="agregarProducto()" style="background:var(--primary); border:none; border-radius:5px; width:50px; font-size:1.5rem; color:black;">+</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN FIREBASE ---
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_PROYECTO.firebaseapp.com",
            databaseURL: "https://TU_PROYECTO-default-rtdb.firebaseio.com",
            projectId: "TU_PROYECTO",
            storageBucket: "TU_PROYECTO.appspot.com",
            messagingSenderId: "NUMERO",
            appId: "ID"
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ESTADO GLOBAL
        let currentUser = null;
        let currentCatID = null;

        // --- FUNCIONES DE SESI√ìN ---
        function login(user) {
            currentUser = user;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            document.getElementById('user-display').innerText = user;
            iniciarEscuchas();
        }

        function iniciarEscuchas() {
            // Escuchar Categor√≠as
            db.ref('categorias').orderByChild('nombre').on('value', snap => {
                renderCategorias(snap.val() || {});
            });
            // Escuchar Productos
            db.ref('productos').on('value', snap => {
                const prods = snap.val() || {};
                renderSinStock(prods);
                if(currentCatID) renderProductos(prods);
            });
        }

        // --- RENDERIZADO ---
        function renderCategorias(catsObj) {
            const list = document.getElementById('categories-list');
            list.innerHTML = '';
            
            // Convertir objeto a array y ordenar alfabeticamente
            const sortedCats = Object.keys(catsObj).map(key => ({id: key, ...catsObj[key]}));
            sortedCats.sort((a,b) => a.nombre.localeCompare(b.nombre));

            sortedCats.forEach(cat => {
                const el = document.createElement('div');
                const ocupadoPorOtro = cat.usuario_activo && cat.usuario_activo !== currentUser;
                const ocupadoPorMi = cat.usuario_activo === currentUser;

                el.className = `cat-card ${ocupadoPorOtro ? 'busy' : ''} ${ocupadoPorMi ? 'active-user' : ''}`;
                
                let statusInfo = "";
                if(ocupadoPorOtro) statusInfo = `<span class="cat-status" style="color:var(--busy)">En uso: ${cat.usuario_activo}</span>`;
                if(ocupadoPorMi) statusInfo = `<span class="cat-status" style="color:var(--primary)">TU SECTOR</span>`;

                el.innerHTML = `<span>${cat.nombre}</span> ${statusInfo}`;
                
                el.onclick = () => {
                    if(!ocupadoPorOtro) entrarCategoria(cat.id, cat.nombre);
                };
                list.appendChild(el);
            });
        }

        function renderSinStock(prodsObj) {
            const container = document.getElementById('sin-stock-list');
            const wrapper = document.getElementById('sin-stock-container');
            container.innerHTML = '';
            
            let hayItems = false;
            Object.keys(prodsObj).forEach(key => {
                const p = prodsObj[key];
                if(p.en_stock === false) { // Expl√≠citamente false
                    hayItems = true;
                    container.appendChild(crearProductoHTML(key, p, true));
                }
            });
            wrapper.style.display = hayItems ? 'block' : 'none';
        }

        function renderProductos(prodsObj) {
            const container = document.getElementById('products-list');
            container.innerHTML = '';
            
            // Filtramos por categor√≠a actual Y que tengan stock
            // Los que no tienen stock se van a la lista roja principal
            const misProds = Object.keys(prodsObj)
                .filter(k => prodsObj[k].categoria_id === currentCatID && prodsObj[k].en_stock !== false)
                .map(k => ({id: k, ...prodsObj[k]}));

            // Ordenar por campo 'orden' (original)
            misProds.sort((a,b) => (a.orden || 0) - (b.orden || 0));

            misProds.forEach(p => {
                container.appendChild(crearProductoHTML(p.id, p, false));
            });
        }

        function crearProductoHTML(id, p, esSinStock) {
            const div = document.createElement('div');
            div.className = `prod-card ${p.controlado ? 'checked' : ''}`;
            
            const btnStockClass = p.en_stock === false ? 'sin-stock' : '';
            const btnStockText = p.en_stock === false ? 'SIN STOCK' : 'EN STOCK';
            const catOrigen = esSinStock ? `<small style="color:#777">Origen: ${p.cat_nombre || 'N/A'}</small>` : '';

            div.innerHTML = `
                <div class="prod-details">
                    <span class="prod-name" contenteditable="true" onblur="editarNombre('${id}', this.innerText)">${p.nombre}</span>
                    ${catOrigen}
                </div>
                <div class="actions">
                    <button class="btn-copy" onclick="copiar('${id}', '${p.nombre}')">COPIAR</button>
                    <div class="stock-toggle ${btnStockClass}" onclick="toggleStock('${id}', ${p.en_stock})">${btnStockText}</div>
                    ${!esSinStock ? `<small style="color:#555; font-size:0.6rem; cursor:pointer" onclick="eliminar('${id}')">Eliminar</small>` : ''}
                </div>
            `;
            return div;
        }

        // --- L√ìGICA DE NEGOCIO ---

        function entrarCategoria(id, nombre) {
            currentCatID = id;
            document.getElementById('cat-title').innerText = nombre;
            document.getElementById('view-categories').style.display = 'none';
            document.getElementById('view-products').style.display = 'block';
            window.scrollTo(0,0);

            // Bloquear categor√≠a
            db.ref(`categorias/${id}`).update({ usuario_activo: currentUser });
            db.ref(`categorias/${id}/usuario_activo`).onDisconnect().set("");
            
            // Cargar productos inicial
            db.ref('productos').once('value', s => renderProductos(s.val() || {}));
        }

        function salirCategoria() {
            if(currentCatID) {
                // Desbloquear
                db.ref(`categorias/${currentCatID}`).update({ usuario_activo: "" });
                db.ref(`categorias/${currentCatID}/usuario_activo`).onDisconnect().cancel();
                
                currentCatID = null;
                document.getElementById('view-products').style.display = 'none';
                document.getElementById('view-categories').style.display = 'block';
            }
        }

        function copiar(id, texto) {
            navigator.clipboard.writeText(texto).then(() => {
                // Marcar como controlado (verde)
                db.ref(`productos/${id}`).update({ controlado: true });
                if(navigator.vibrate) navigator.vibrate(50);
            });
        }

        function toggleStock(id, estadoActual) {
            // Si es undefined o true, pasa a false. Si es false, pasa a true.
            const nuevoEstado = estadoActual === false ? true : false;
            db.ref(`productos/${id}`).update({ en_stock: nuevoEstado });
        }

        function agregarProducto() {
            const input = document.getElementById('new-prod-name');
            const nombre = input.value.trim();
            if(!nombre) return;
            
            db.ref('productos').push({
                nombre: nombre,
                categoria_id: currentCatID,
                cat_nombre: document.getElementById('cat-title').innerText,
                en_stock: true,
                controlado: false,
                orden: Date.now() // Truco para que vaya al final
            });
            input.value = '';
        }

        function editarNombre(id, val) {
            db.ref(`productos/${id}`).update({ nombre: val });
        }

        function eliminar(id) {
            if(confirm("¬øBorrar producto permanentemente?")) {
                db.ref(`productos/${id}`).remove();
            }
        }

        function reiniciarDia() {
            if(confirm("¬øINICIAR NUEVO D√çA?\n\n- Se borrar√°n los colores verdes (controlados).\n- Se liberar√°n las categor√≠as.\n- Lo que est√° 'Sin Stock' SE MANTENDR√Å sin stock.")) {
                
                // 1. Resetear Controlados
                db.ref('productos').once('value', snap => {
                    const updates = {};
                    snap.forEach(child => {
                        updates[`productos/${child.key}/controlado`] = false;
                    });
                    
                    // 2. Liberar Categor√≠as
                    db.ref('categorias').once('value', catSnap => {
                        catSnap.forEach(c => {
                            updates[`categorias/${c.key}/usuario_activo`] = "";
                        });
                        db.ref().update(updates);
                    });
                });
            }
        }
    </script>
</body>
</html>
